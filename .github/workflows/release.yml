name: Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Build App
        run: sh build_app.sh

      - name: Setup Sparkle Tools
        run: |
          mkdir -p sparkle_tools
          curl -L https://github.com/sparkle-project/Sparkle/releases/download/2.6.4/Sparkle-2.6.4.tar.xz | tar -xJ -C sparkle_tools
          echo "$(pwd)/sparkle_tools/bin" >> $GITHUB_PATH

      - name: Sign and Generate Appcast
        if: startsWith(github.ref, 'refs/tags/')
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          # 1. Sign the release ZIP
          # The private key is passed via the SPARKLE_PRIVATE_KEY env var
          # which Sparkle's sign_update tool looks for automatically.
          SIGNATURE=$(sign_update Pomodoro_macOS_Universal.zip)
          echo "Signature: $SIGNATURE"

          # 2. Create a folder for appcast generation
          mkdir -p appcast_work
          cp Pomodoro_macOS_Universal.zip appcast_work/
          
          # 3. Generate the appcast.xml
          # We point it to the GitHub downloads URL
          REPO_URL="https://github.com/${{ github.repository }}/releases/latest/download"
          generate_appcast --download-url-prefix "$REPO_URL" appcast_work/
          
          # 4. Move appcast.xml to root for hosting on main branch
          mv appcast_work/appcast.xml .

      - name: Commit Appcast
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add appcast.xml
          git commit -m "chore: update appcast.xml [skip ci]" || echo "No changes to appcast"
          git push origin main

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            Pomodoro_v*_macOS_Universal.zip
            Pomodoro_macOS_Universal.zip
            appcast.xml
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
