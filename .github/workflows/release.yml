name: Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Explicitly check out the ref that triggered the event (the tag)
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Set Environment Variables
        run: |
          if [[ "${{ github.ref_name }}" == *"-staging"* ]]; then
            echo "IS_STAGING=true" >> $GITHUB_ENV
            echo "TARGET_BRANCH=staging" >> $GITHUB_ENV
            echo "APPCAST_FILE=appcast-staging.xml" >> $GITHUB_ENV
            echo "PRERELEASE=true" >> $GITHUB_ENV
          else
            echo "IS_STAGING=false" >> $GITHUB_ENV
            echo "TARGET_BRANCH=main" >> $GITHUB_ENV
            echo "APPCAST_FILE=appcast.xml" >> $GITHUB_ENV
            echo "PRERELEASE=false" >> $GITHUB_ENV
          fi

      - name: Build App
        run: |
          chmod +x build_app.sh
          ./build_app.sh

      - name: Setup Sparkle Tools
        run: |
          mkdir -p sparkle_tools
          # We use the same Sparkle version as in Package.resolved (2.8.1)
          curl -L https://github.com/sparkle-project/Sparkle/releases/download/2.8.1/Sparkle-2.8.1.tar.xz | tar -xJ -C sparkle_tools
          echo "$(pwd)/sparkle_tools/bin" >> $GITHUB_PATH

      - name: Sign and Generate Appcast
        if: startsWith(github.ref, 'refs/tags/')
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          # 1. Verify file exists
          if [ ! -f Pomodoro_macOS_Universal.zip ]; then
            echo "‚ùå Error: Pomodoro_macOS_Universal.zip not found!"
            exit 1
          fi

          # 2. Securely create the key file
          printf "%s" "$SPARKLE_PRIVATE_KEY" > sparkle_key.priv
          chmod 600 sparkle_key.priv
          
          # 3. Create workspace for appcast
          mkdir -p appcast_work
          cp Pomodoro_macOS_Universal.zip appcast_work/

          # 4. Generate the signed appcast
          echo "üåê Generating signed $APPCAST_FILE..."
          # Use a trailing slash to ensure the filename is appended correctly
          REPO_URL="https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/"
          
          ./sparkle_tools/bin/generate_appcast \
            --download-url-prefix "$REPO_URL" \
            --ed-key-file sparkle_key.priv \
            appcast_work/
          
          # 5. Verify and Move
          if [ -f "appcast_work/appcast.xml" ]; then
            mv "appcast_work/appcast.xml" "./$APPCAST_FILE"
            echo "‚úÖ $APPCAST_FILE created and signed successfully."
          else
            echo "‚ùå Error: appcast.xml was not generated!"
            rm -f sparkle_key.priv
            exit 1
          fi

          # 6. Cleanup
          rm -f sparkle_key.priv

      - name: Commit Appcast
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin $TARGET_BRANCH:$TARGET_BRANCH
          git add "$APPCAST_FILE"
          git commit -m "chore: update $APPCAST_FILE [skip ci]" || echo "No changes to appcast"
          git push origin HEAD:$TARGET_BRANCH

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            Pomodoro_macOS_Universal.zip
            ${{ env.APPCAST_FILE }}
          draft: false
          prerelease: ${{ env.PRERELEASE == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
